# Linux-resource-monitoring-bot

Этот проект содержит Telegram-бота для мониторинга системных метрик удалённых машин по SSH и отправки отчётов в Telegram. Также в комплекте есть скрипт `setup_bot.sh` для установки необходимых библиотек и запуска бота с возможностью создания systemd-сервиса.

---

## Описание бота

Бот подключается по SSH к заданным машинам, собирает метрики CPU, RAM, Swap, Используемое место на диске, Использование TCP памяти и количество соединений (concurrent connections), формирует отчёт с указанием разницы по сравнению с предыдущим часом и отправляет его в указанный Telegram-чат каждый час. Предыдущие метрики сохраняются в файл data.json для корректного расчета разниц после перезапуска бота.

---

## Конфигурация

- В файле `config.py` задайте:

  - `TOKEN` — токен вашего Telegram-бота.
  - `CHAT_ID` — ID чата или канала, куда будут отправляться отчёты.
  - `TIMEZONE_OFFSET` — смещение часового пояса для отображения времени в отчетах (в часах, по умолчанию 3).
  - `MACHINES` — список словарей с параметрами подключения к удалённым машинам (`name`, `host`, `user`, `password`, `key_filename`).

---

## Подключение к серверам
- Бот поддерживает два способа аутентификации по SSH:
  - **По паролю** — указываете логин и пароль в конфигурации.
  - **По SSH-ключу** — указываете логин и путь к приватному ключу.

  Вы можете использовать любой удобный для вас способ, либо оба одновременно (бот попробует подключиться по ключу, а при неудаче — по паролю).
---
## Пример конфигурации машин
```
MACHINES = [
    {
        "name": "Server 1",
        "host": "1.1.1.1",
        "user": "username",
        "password": "your_password",       # Для подключения по паролю
        "key_filename": None                # Или путь к приватному ключу, например "/home/user/.ssh/id_rsa"
    },
    {
        "name": "Server 2",
        "host": "2.2.2.2",
        "user": "username",
        "password": None,
        "key_filename": "/home/user/.ssh/id_rsa"  # Подключение по ключу
    },
]
```
---

## Использование скрипта установки `setup_bot.sh`

Скрипт автоматизирует создание виртуального окружения, установку зависимостей, запуск бота и (опционально) создание systemd-сервиса.

### Права
Для создания systemd-сервиса требуется запускать скрипт с пользователем, который имеет права на `sudo` для команд `systemctl` и записи в `/etc/systemd/system/`.

### Запуск скрипта

```bash
chmod +x setup_bot.sh
./setup_bot.sh [опции]
```

**Примечание:** Если скрипт не запускается, возможно, файл имеет Windows-формат (CRLF). Преобразуйте его в Unix-формат:
- Если установлен `dos2unix`: `dos2unix setup_bot.sh`
- Или с помощью `sed`: `sed -i 's/\r$//' setup_bot.sh`
---
## Доступные флаги
| Флаг       | Описание |
|-----------|--------|
| -s | Запустить бота с созданием и запуском systemd-сервиса. Если не указан, бот запускается в интерактивном режиме без сервиса. |
| -d | Удалить скрипт setup_bot.sh после выполнения. |
| -n <name> | Задать имя systemd-сервиса (по умолчанию telegram-bot). |
| -h | Показать справку. |

---

## Примеры использования setup-bot.sh

### Запустить бота без systemd-сервиса (интерактивно):
```
./setup_bot.sh
```
### Запустить бота с созданием и запуском systemd-сервиса с именем по умолчанию:
```
./setup_bot.sh -s
```
### Запустить с сервисом и задать имя сервиса mybot:
```
./setup_bot.sh -s -n mybot
```
### Запустить с сервисом и удалить скрипт после установки:
```
./setup_bot.sh -s -d
```
### Показать справку:
```
./setup_bot.sh -h
```

---

## Запуск бота вручную

### Если вы не используете systemd-сервис, можно запустить бота вручную:

```
source ./venv/bin/activate # Активируем виртуальное окружение (venv должен находиться в директории проекта)
pip install paramiko python-telegram-bot # Устанавливаем необходимые библиотеки (если ещё не установлены)
python ./bot.py # Запускаем бота
```

---

## Файлы проекта

- `bot.py` — основной файл бота.
- `config.py` — конфигурация машин.
- `setup_bot.sh` — скрипт установки и запуска.
- `.gitignore` — файл для игнорирования временных файлов.

## Требования
- Python 3.12+
- Пакеты Python: python-telegram-bot, paramiko
- SSH доступ к удалённым машинам с указанными логинами и паролями
- Для systemd-сервиса: права sudo для управления сервисами
